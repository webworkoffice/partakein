<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.1//EN"
        "http://struts.apache.org/dtds/struts-2.1.dtd">

<struts>
	<!-- For Debugging. These setting should be removed when releasing. -->
	<!-- constant name="struts.devMode" value="true" -->
	<!-- Use partake theme -->
	<constant name="struts.ui.theme" value="partake" />

	<constant name="struts.enable.SlashesInActionNames" value="true" />
	<constant name="struts.mapper.alwaysSelectFullNamespace" value="false" />
	<constant name="struts.action.extension" value=",action,ics,csv" />
	
	<package name="partake-default" extends="struts-default">
		<result-types>
			<result-type name="partake-stream" class="in.partake.controller.PartakeStreamResult" />
		</result-types>
	
		<interceptors>
			<interceptor name="utf8encoding"     class="in.partake.controller.interceptor.UTF8EncodingInterceptor" />
	    	<interceptor name="authenticate"     class="in.partake.controller.interceptor.LoginRequiredInterceptor" />
	    	<interceptor name="adminAuth"        class="in.partake.controller.interceptor.AdminRequiredInterceptor" />
	    	<interceptor name="dynamicInfo"      class="in.partake.controller.interceptor.DynamicInformationInterceptor" />
	    	<interceptor name="exceptionHandler" class="in.partake.controller.interceptor.PartakeExceptionInterceptor" />
	    	<interceptor name="csrfToken"        class="in.partake.controller.interceptor.CSRFTokenInterceptor" />
	    	<interceptor name="csrfTokenCheck"   class="in.partake.controller.interceptor.CSRFTokenCheckInterceptor" />

	    	<interceptor-stack name="partakeBaseStack">
	    		<interceptor-ref name="utf8encoding" />
	    		<interceptor-ref name="store">
                    <param name="operationMode">AUTOMATIC</param>
	    		</interceptor-ref>
	    		<interceptor-ref name="dynamicInfo" />
	    		<interceptor-ref name="defaultStack" />
	    		<interceptor-ref name="csrfToken" />
	    	</interceptor-stack>

	    	<interceptor-stack name="partakeStack">
                <interceptor-ref name="partakeBaseStack"/>
	    		<interceptor-ref name="exceptionHandler"/>
	    	</interceptor-stack>

	    	<interceptor-stack name="authenticateStack">
                <interceptor-ref name="partakeBaseStack"/>
                <interceptor-ref name="authenticate"/>
                <interceptor-ref name="exceptionHandler"/>
            </interceptor-stack>

            <interceptor-stack name="adminStack">
                <interceptor-ref name="partakeBaseStack"/>
                <interceptor-ref name="adminAuth" />
                <interceptor-ref name="exceptionHandler"/>
            </interceptor-stack>

	    	<interceptor-stack name="checkTokenStack">
                <interceptor-ref name="partakeBaseStack"/>
                <interceptor-ref name="authenticate"/>
                <interceptor-ref name="exceptionHandler"/>
	    		<interceptor-ref name="csrfTokenCheck" /><!-- This may throw PartakeResultException -->
	    	</interceptor-stack>
 	    </interceptors>

		<default-interceptor-ref name="partakeStack"/>

		<global-results>
			<result name="login" type="redirectAction">
				<param name="namespace">/auth</param>
				<param name="actionName">loginRequired</param>
				<param name="redirectURL">${redirectURL}</param>
			</result>
			<result name="redirect" type="redirect">${redirectURL}</result>
			<result name="error" type="redirect">/error</result>
			<result name="invalid" type="redirect">/invalid</result>
			<result name="notfound" type="redirect">/notfound</result>
			<result name="prohibited" type="redirect">/prohibited</result>
			<result name="returntop" type="redirect">/</result>
			<result name="stream" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="contentDisposition">${contentDisposition}</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>			
			</result>
			<result name="json" type="partake-stream">
                <param name="contentType">text/json; charset=utf-8</param>
                <param name="bufferSize">20K</param>
                <param name="allowCaching">false</param>
                <param name="status">${status}</param>
                <param name="headers">${headers}</param>
            </result>			
		</global-results>
	</package>

	<package name="partake-api-default" extends="partake-default">
		<result-types>
			<result-type name="partake-api-error" class="in.partake.controller.PartakeAPIErrorResult" />
		</result-types>

		<global-results>
			<result name="error" type="partake-api-error">
                <param name="contentType">text/json; charset=utf-8</param>
                <param name="bufferSize">20K</param>
                <param name="allowCaching">false</param>
			</result>
		</global-results>	
	</package>

	<package name="top" namespace="/" extends="partake-default">
        <action name="" method="index" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/index.jsp</result>
        </action>

        <action name="error" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/error.jsp</result>
        </action>

        <action name="invalid" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/invalid.jsp</result>
        </action>

        <action name="contact" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/contact.jsp</result>
        </action>

        <action name="termofuse" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/termofuse.jsp</result>
        </action>

        <action name="feedlist" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/feedlist.jsp</result>
        </action>

        <action name="notfound" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/notfound.jsp</result>
        </action>

        <action name="prohibited" method="alwaysSuccess" class="in.partake.controller.ToppageController">
            <result name="success">/WEB-INF/prohibited</result>
        </action>

		<action name="mypage" method="show" class="in.partake.controller.MypageController">
			<interceptor-ref name="authenticateStack" />
			<result name="success">/WEB-INF/mypage.jsp</result>
		</action>

		<action name="preference" method="showPreference" class="in.partake.controller.UsersPreferenceController">
			<interceptor-ref name="authenticateStack" />
			<result name="success">/WEB-INF/preference.jsp</result>
		</action>

		<action name="setPreference" method="setPreference" class="in.partake.controller.UsersPreferenceController">
            <interceptor-ref name="checkTokenStack" />
			<result name="input" type="redirect">/preference</result>
			<result name="success" type="redirect">/preference</result>
		</action>

		<action name="revokeCalendar" method="revokeCalendar" class="in.partake.controller.UsersController">
            <interceptor-ref name="checkTokenStack" />
			<result name="input">/WEB-INF/setting.jsp</result>
			<result name="success" type="redirect">/preference</result>
		</action>
	</package>

	<package name="auth" namespace="/auth" extends="partake-default">
        <action name="loginByTwitter" method="loginByTwitter" class="in.partake.controller.AuthenticationController">
            <result name="success" type="redirect">${redirectURL}</result>
        </action>
        <action name="verifyForTwitter" method="verifyForTwitter" class="in.partake.controller.AuthenticationController">
            <result name="success" type="redirect">/</result>
        </action>

        <action name="loginByOpenID" method="loginByOpenID" class="in.partake.controller.AuthenticationController">
            <result name="success"  type="redirect">${redirectURL}</result>
        </action>
        <action name="connectWithOpenID" method="connectWithOpenID" class="in.partake.controller.AuthenticationController">
            <interceptor-ref name="checkTokenStack" />
            <result name="success" type="redirect">${redirectURL}</result>
        </action>
        <action name="verifyOpenID" method="verifyOpenID" class="in.partake.controller.AuthenticationController">
            <result name="success" type="redirect">/</result>
        </action>

		<action name="logout" method="logout" class="in.partake.controller.AuthenticationController">
			<result name="success" type="redirect">/</result>
		</action>
		<action name="loginRequired" method="loginRequired" class="in.partake.controller.AuthenticationController">
			<result name="success">/WEB-INF/auth/loginRequired.jsp</result>
		</action>
	</package>

	<package name="admin" namespace="/admin" extends="partake-default">
        <action name="" method="index" class="in.partake.controller.AdministratorController">
            <interceptor-ref name="adminStack" />
            <result name="success">/WEB-INF/admin/index.jsp</result>
        </action>
        <action name="debug" method="debug" class="in.partake.controller.AdministratorController">
            <interceptor-ref name="adminStack" />
            <result name="success" type="redirect">/</result>
        </action>
        <action name="createDemoPage" method="createDemoPage" class="in.partake.controller.AdministratorController">
            <interceptor-ref name="adminStack" />
            <result name="success" type="redirect">/</result>
        </action>
        <action name="addFeedIdToAllEvents" method="addFeedIdToAllEvents" class="in.partake.controller.AdministratorController">
            <interceptor-ref name="adminStack" />
            <result name="success" type="redirect">/</result>
        </action>
	</package>

	<package name="users" namespace="/users" extends="partake-default">
		<action name="*" method="show" class="in.partake.controller.UsersController">
			<interceptor-ref name="partakeStack"/>

	        <param name="userId">{1}</param>
			<result name="success">/WEB-INF/users/show.jsp</result>
			<result name="prohibited">/WEB-INF/users/private.jsp</result>
		</action>
	</package>

	<package name="calendars" namespace="/calendars" extends="partake-default">
        <action name="all" method="all" class="in.partake.controller.CalendarsController">
            <result name="success" type="stream">
                <param name="contentType">text/calendar; charset=utf-8</param>
                <param name="contentDisposition">inline; filename="allevents.ics"</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param><!-- TODO: true? false? -->
            </result>
        </action>

        <action name="category/*" method="showCategory" class="in.partake.controller.CalendarsController">
            <param name="category">{1}</param>

            <result name="success" type="stream">
                <param name="contentType">text/calendar; charset=utf-8</param>
                <param name="contentDisposition">inline; filename="category.ics"</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
            </result>
        </action>

		<action name="*" method="show" class="in.partake.controller.CalendarsController">
			<param name="calendarId">{1}</param>

			<result name="success" type="stream">
				<param name="contentType">text/calendar; charset=utf-8</param>
				<param name="contentDisposition">inline; filename="partake.ics"</param>
				<param name="bufferSize">1M</param>
				<param name="allowCaching">true</param>
			</result>
		</action>
	</package>

	<package name="events" namespace="/events" extends="partake-default">
		<!-- Event Editing -->
		<action name="new" method="editNew" class="in.partake.controller.EventsEditController">
			<interceptor-ref name="authenticateStack"/>
			<result name="input">/WEB-INF/events/new.jsp</result>
		</action>
		<action name="create" method="create" class="in.partake.controller.EventsEditController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input">/WEB-INF/events/new.jsp</result>
		</action>
 		<action name="edit" method="edit" class="in.partake.controller.EventsEditController">
            <interceptor-ref name="authenticateStack" />
			<result name="input">/WEB-INF/events/edit.jsp</result>
		</action>
		<action name="commit" method="commit" class="in.partake.controller.EventsEditController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input">/WEB-INF/events/edit.jsp</result>
		</action>
		<action name="destroy" method="destroy" class="in.partake.controller.EventsEditController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirect">/</result>
		</action>

		<action name="search" method="search" class="in.partake.controller.EventsSearchController">
			<interceptor-ref name="partakeStack"/>

			<result name="success">/WEB-INF/events/search.jsp</result>
			<result name="input">/WEB-INF/events/search.jsp</result>
		</action>

		<!-- Event enrollments -->
		<action name="enroll" method="enroll" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
		</action>
		<action name="reserve" method="reserve" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
		</action>
        <action name="cancel" method="cancel" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
            <result name="success" type="redirectAction">
                <param name="actionName">${eventId}</param>
            </result>
        </action>
        <action name="changeComment" method="changeComment" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
            <result name="success" type="redirectAction">
                <param name="actionName">${eventId}</param>
            </result>
        </action>

		<!-- Event Messaging -->
		<action name="send" method="send" class="in.partake.controller.EventsMessageController">
			<interceptor-ref name="authenticateStack" />

			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
		</action>

		<!-- Event Commenting -->
		<action name="comment" method="comment" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
		</action>
		<action name="removeComment" method="removeComment" class="in.partake.controller.EventsController">
            <interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
		</action>

		<!-- Event Image Showing -->
		<action name="images/*" method="show" class="in.partake.controller.EventsImageController">
			<param name="imageId">{1}</param>

			<result name="success" type="stream">
				<param name="contentType">${contentType}</param>
				<param name="contentDisposition">inline</param>
				<param name="bufferSize">1M</param>
				<param name="allowCaching">true</param>
			</result>
		</action>

		<!-- Event Viewing -->
		<action name="passcode" method="passcode" class="in.partake.controller.EventsPasscodeController">
			<interceptor-ref name="partakeStack"/>

            <result name="success" type="redirectAction">
                <param name="actionName">${eventId}</param>
            </result>
            <result name="input">/WEB-INF/events/passcode.jsp</result>
		</action>

		<!-- Questionnaire -->
		<action name="editQuestionnaire" method="edit" class="in.partake.controller.action.QuestionnaireController">
			<interceptor-ref name="authenticateStack" />
			<result name="success">/WEB-INF/events/questionnaire/edit.jsp</result>
		</action>
		<action name="makeQuestionnaire" method="commit" class="in.partake.controller.action.QuestionnaireController">
			<interceptor-ref name="checkTokenStack" />
			<result name="success" type="redirectAction">
				<param name="actionName">${eventId}</param>
			</result>
			<result name="input">/WEB-INF/events/questionnaire/edit.jsp</result>
		</action>

		<!-- Event Participants -->
		<!-- URL はきれいにしたいな... -->
		<action name="participants/*" method="showCSV" class="in.partake.controller.EventParticipantsController">
            <interceptor-ref name="partakeStack" />
            <param name="eventId">{1}</param>

            <result name="success" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="contentDisposition">attachment</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
            </result>
        </action>

        <action name="showParticipants/*" method="showParticipants" class="in.partake.controller.EventParticipantsController">
            <interceptor-ref name="partakeStack" />
            <param name="eventId">{1}</param>

            <result name="success">/WEB-INF/events/participants/show.jsp</result>
        </action>

        <action name="printParticipants/*" method="showParticipants" class="in.partake.controller.EventParticipantsController">
            <interceptor-ref name="partakeStack" />
            <param name="eventId">{1}</param>

            <result name="success">/WEB-INF/events/participants/print.jsp</result>
        </action>

        <action name="makeAttendantVIP" method="makeAttendantVIP" class="in.partake.controller.EventParticipantsController">
            <interceptor-ref name="checkTokenStack" />
            <result name="success" type="redirectAction">
            	<param name="actionName">showParticipants/${eventId}</param>
            </result>
        </action>
        <action name="removeAttendant" method="removeAttendant" class="in.partake.controller.EventParticipantsController">
            <interceptor-ref name="checkTokenStack" />
            <result name="success" type="redirectAction">
            	<param name="actionName">showParticipants/${eventId}</param>
            </result>
        </action>


		<!-- Event Show -->
		<action name="*" method="show" class="in.partake.controller.EventsController">
			<interceptor-ref name="partakeStack"/>

	        <param name="eventId">{1}</param>
            <result name="success">/WEB-INF/events/show.jsp</result>
            <result name="removed">/WEB-INF/events/removed.jsp</result>
			<result name="passcode" type="redirectAction">
			    <param name="actionName">passcode</param>
			    <param name="eventId">${eventId}</param>
			</result>
		</action>
	</package>

	<package name="feed" namespace="/feed" extends="partake-default">
		<action name="all" method="feedRecentEvents" class="in.partake.controller.EventsFeedController">
			<result name="success" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
			</result>
		</action>

		<action name="category/*" method="feedCategory" class="in.partake.controller.EventsFeedController">
			<param name="category">{1}</param>
			<result name="success" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
			</result>
		</action>

		<action name="event/*" method="feedEvent" class="in.partake.controller.EventsFeedController">
			<param name="feedId">{1}</param>
			<result name="success" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
			</result>
		</action>

		<action name="user/*" method="feed" class="in.partake.controller.UserFeedController">
			<param name="feedId">{1}</param>
			<result name="success" type="stream">
                <param name="contentType">${contentType}</param>
                <param name="bufferSize">1M</param>
                <param name="allowCaching">true</param>
			</result>
		</action>

		<action name="upcoming/*" method="feedUpcomingEvents" class="in.partake.controller.EventsFeedController">
			<param name="category">{1}</param>
			<result name="success" type="stream">
				<param name="contentType">${contentType}</param>
				<param name="bufferSize">1M</param>
				<param name="allowCaching">true</param>
			</result>
		</action>
	</package>

	<!-- ここから下は Web API 実装 -->
	<package name="api" namespace="/api" extends="partake-api-default">
		<action name="search" method="search" class="in.partake.controller.api.search.SearchAction" />
	</package>
	
	<package name="debug-api" namespace="/api/debug" extends="partake-api-default">
		<action name="success" method="success" class="in.partake.controller.api.debug.DebugAction" />
		<action name="echo" method="echo" class="in.partake.controller.api.debug.DebugAction" />
		<action name="successIfLogin" method="successIfLogin" class="in.partake.controller.api.debug.DebugAction" />
		<action name="invalid" method="invalid" class="in.partake.controller.api.debug.DebugAction" />
		<action name="error" method="error" class="in.partake.controller.api.debug.DebugAction" />
		<action name="errorException" method="errorException" class="in.partake.controller.api.debug.DebugAction" />
		<action name="errorDB" method="errorDB" class="in.partake.controller.api.debug.DebugAction" />
		<action name="errorDBException" method="errorDBException" class="in.partake.controller.api.debug.DebugAction" />
	</package>
	
	<!-- Account API -->
	<package name="account-api" namespace="/api/account" extends="partake-api-default">
		<action name="getSessionToken" method="getSessionToken" class="in.partake.controller.api.account.SessionAction" />
		<action name="getOpenID" method="getOpenID" class="in.partake.controller.api.account.OpenIDAction" />
		<action name="removeOpenID" method="removeOpenID" class="in.partake.controller.api.account.OpenIDAction" />
		<action name="getPreference" method="getPreference" class="in.partake.controller.api.account.PreferenceAction" />
		<action name="setPreference" method="setPreference" class="in.partake.controller.api.account.PreferenceAction" />		
	</package>
	
	<!-- User API -->
	<package name="user-api" namespace="/api/user" extends="partake-api-default">
		<action name="get" method="get" class="in.partake.controller.api.user.UserAction" />
	</package>

	<!-- Event API -->	
	<package name="event-api" namespace="/api/event" extends="partake-api-default">
		<action name="get" method="get" class="in.partake.controller.api.event.EventAction" />
	</package>
	
	<!-- Attendance API -->	
	<package name="attendance-api" namespace="/api/attendance" extends="partake-api-default">
		<action name="change" method="change" class="in.partake.controller.api.attendance.AttendanceAction" />
	</package>
</struts>